# Safer fix for kernel panic in xt_qtaguid when CONFIG_SYSVIPC is enabled
# 
# This is a more conservative version that only affects the problematic code path
# instead of completely disabling network statistics.
#
# Changes:
# - Only skip dev_get_stats when the device appears to be in an invalid state
# - Preserve normal statistics collection for valid devices
# - Add null pointer check before accessing net_dev
#
# This approach is safer because:
# 1. Network statistics still work for valid devices
# 2. Android's network monitoring continues to function
# 3. Only prevents crashes on invalid device access during namespace initialization
#
--- a/net/netfilter/xt_qtaguid.c
+++ b/net/netfilter/xt_qtaguid.c
@@ -737,7 +737,7 @@ static int iface_stat_fmt_proc_show(struct seq_file *m, void *v)
 {
 	struct proc_iface_stat_fmt_info *p = m->private;
 	struct iface_stat *iface_entry;
-	struct rtnl_link_stats64 dev_stats, *stats;
+	struct rtnl_link_stats64 dev_stats, *stats = NULL;
 	struct rtnl_link_stats64 no_dev_stats = {0};
 
 
@@ -746,10 +746,14 @@ static int iface_stat_fmt_proc_show(struct seq_file *m, void *v)
 
 	iface_entry = list_entry(v, struct iface_stat, list);
 
-	if (iface_entry->active) {
+	/* Only access device stats if device is active AND net_dev is valid */
+	if (iface_entry->active && iface_entry->net_dev) {
 		stats = dev_get_stats(iface_entry->net_dev,
 				      &dev_stats);
-	} else {
+	}
+	
+	/* Use zero stats if device inactive or net_dev is NULL */
+	if (!stats) {
 		stats = &no_dev_stats;
 	}
 	/*

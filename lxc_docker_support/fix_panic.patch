# Fix for kernel panic in xt_qtaguid when CONFIG_SYSVIPC is enabled
# 
# This patch prevents a kernel panic during boot that occurs when IPC namespace
# configurations (CONFIG_SYSVIPC, CONFIG_IPC_NS) are enabled for Docker/LXC support.
#
# The issue occurs in net/netfilter/xt_qtaguid.c when the module tries to access
# network device statistics during early boot. With namespaces enabled, these
# device pointers may be invalid or uninitialized, causing a null pointer
# dereference or similar crash.
#
# The fix changes the behavior to always use no_dev_stats instead of trying
# to access potentially invalid device statistics. This is safe because:
# 1. The statistics are primarily used for traffic monitoring/accounting
# 2. Using zero stats is better than crashing the system
# 3. The actual device stats will be properly tracked once the system is fully booted
#
# Side effects: Network traffic statistics may not be fully accurate during
# early boot phase, but this is acceptable compared to a complete boot failure.
#
# Based on: https://github.com/tomxi1997/lxc-docker-support-for-android
#
--- a/net/netfilter/xt_qtaguid.c
+++ b/net/netfilter/xt_qtaguid.c
@@ -737,7 +737,7 @@ static int iface_stat_fmt_proc_show(struct seq_file *m, void *v)
 {
 	struct proc_iface_stat_fmt_info *p = m->private;
 	struct iface_stat *iface_entry;
-	struct rtnl_link_stats64 dev_stats, *stats;
+	struct rtnl_link_stats64 *stats;
 	struct rtnl_link_stats64 no_dev_stats = {0};
 
 
@@ -746,12 +746,7 @@ static int iface_stat_fmt_proc_show(struct seq_file *m, void *v)
 
 	iface_entry = list_entry(v, struct iface_stat, list);
 
-	if (iface_entry->active) {
-		stats = dev_get_stats(iface_entry->net_dev,
-				      &dev_stats);
-	} else {
-		stats = &no_dev_stats;
-	}
+	stats = &no_dev_stats;
 	/*
 	 * If the meaning of the data changes, then update the fmtX
 	 * string.
